---
interface Link {
  href: string;
  label: string;
}

interface Props {
  triggerText: string;
  links: Link[];
  triggerHref?: string;
}

const { triggerText, links, triggerHref = "#" } = Astro.props;
---

<li class="nav-bar__dropdown">
  <a
    href={triggerHref}
    class="nav-bar__link nav-bar__dropdown-toggle"
    aria-haspopup="true"
    aria-expanded="false"
  >
    {triggerText}
    <img
      src="/icons/caret-drk-down.svg"
      alt="dropdown menu"
      class="nav-bar__caret"
      width="24"
      height="24"
    />
  </a>

  <!-- Dropdown Menu -->
  <ul class="nav-bar__dropdown-menu" role="menu">
    {
      links.map((link) => (
        <li role="none">
          <a href={link.href} class="nav-bar__dropdown-link" role="menuitem">
            {link.label}
          </a>
        </li>
      ))
    }
  </ul>
</li>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const dropdownToggle = document.querySelector(".nav-bar__dropdown-toggle");
    const dropdown = document.querySelector(".nav-bar__dropdown");

    if (!dropdownToggle || !dropdown) return;

    let clickCount = 0;
    let clickTimer: NodeJS.Timeout;
    let preventAutoClose = false;

    function toggleDropdown() {
      if (!dropdown || !dropdownToggle) return;

      const isOpen = dropdown.classList.contains("open");

      // Close all other dropdowns
      document.querySelectorAll(".nav-bar__dropdown.open").forEach((d) => {
        if (d !== dropdown) {
          d.classList.remove("open");
          const toggle = d.querySelector(".nav-bar__dropdown-toggle");
          if (toggle) toggle.setAttribute("aria-expanded", "false");
        }
      });

      if (!isOpen) {
        openDropdown();
      } else {
        closeDropdown();
      }
    }

    function handleDropdownClick(e: Event) {
      if (!dropdownToggle) return;
      e.preventDefault();

      clickCount++;

      if (clickCount === 1) {
        toggleDropdown();
        clickTimer = setTimeout(() => {
          clickCount = 0;
        }, 300);
      } else if (clickCount === 2) {
        clearTimeout(clickTimer);
        clickCount = 0;
        window.location.href = dropdownToggle.getAttribute("href") || "#";
      }
    }

    function openDropdown() {
      if (!dropdown || !dropdownToggle) return;
      dropdown.classList.add("open");
      dropdownToggle.setAttribute("aria-expanded", "true");
    }

    function closeDropdown() {
      if (!dropdown || !dropdownToggle) return;
      dropdown.classList.remove("open");
      dropdownToggle.setAttribute("aria-expanded", "false");
    }

    // Event handlers
    function handleMouseEnter() {
      if (!preventAutoClose) {
        openDropdown();
      }
    }

    function handleMouseLeave() {
      if (!preventAutoClose) {
        closeDropdown();
      }
    }

    function handleDocumentClick(e: Event) {
      if (!e.target || !dropdown || !dropdown.contains(e.target as Node)) {
        closeDropdown();
        preventAutoClose = false;
        clickCount = 0;
      }
    }

    function handleDropdownLinkClick(e: Event) {
      if (!e.target) return;
      if ((e.target as Element).closest(".nav-bar__dropdown-link")) {
        closeDropdown();
      }
    }

    function removeAllListeners() {
      if (!dropdown || !dropdownToggle) return;
      dropdownToggle.removeEventListener("click", handleDropdownClick);
      dropdown.removeEventListener("mouseenter", handleMouseEnter);
      dropdown.removeEventListener("mouseleave", handleMouseLeave);
      document.removeEventListener("click", handleDocumentClick);
      dropdown.removeEventListener("click", handleDropdownLinkClick);
    }

    function setupEventListeners() {
      if (!dropdown || !dropdownToggle) return;
      removeAllListeners();

      const isMobile = window.innerWidth < 992;

      if (isMobile) {
        // Mobile: Click to toggle, click outside to close
        dropdownToggle.addEventListener("click", handleDropdownClick);
        document.addEventListener("click", handleDocumentClick);
      } else {
        // Desktop: Hybrid hover + click behavior
        dropdownToggle.addEventListener("click", (e) => {
          e.preventDefault();
          preventAutoClose = true;
          handleDropdownClick(e);
        });

        dropdown.addEventListener("mouseenter", handleMouseEnter);
        dropdown.addEventListener("mouseleave", handleMouseLeave);
        document.addEventListener("click", handleDocumentClick);
        dropdown.addEventListener("click", handleDropdownLinkClick);
      }
    }

    // Initial setup
    setupEventListeners();

    // Update on resize
    window.addEventListener("resize", setupEventListeners);
  });
</script>

<style>
  .nav-bar__dropdown > .nav-bar__dropdown-toggle {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    width: 100%;
  }
  .nav-bar__caret {
    width: 10.54px;
    height: 6.25px;
    transform: rotate(-90deg);
    transition: transform 0.2s ease;
    margin-left: auto;
  }
  .nav-bar__dropdown.open .nav-bar__caret {
    transform: rotate(0deg);
  }

  .nav-bar__dropdown .nav-bar__dropdown-menu {
    display: none;
    margin-top: 10px;
    background-color: var(--neutral-lightest);
    width: 100%;
    border-radius: 3px;
  }

  .nav-bar__dropdown.open .nav-bar__dropdown-menu {
    display: block;
  }

  .nav-bar__dropdown-link {
    display: block;
    color: var(--text);
    font-size: var(--fs-body-r);
    padding: 14px 12px;
    width: 100%;
    border-bottom: 1px solid var(--grey-10);
  }
  .nav-bar__dropdown-menu li:last-child .nav-bar__dropdown-link {
    border-bottom: none;
  }

  @media (min-width: 992px) {
    .nav-bar__dropdown {
      position: relative;
    }

    .nav-bar__dropdown .nav-bar__dropdown-menu {
      position: absolute;
      top: 100%;
      left: 7px;
      display: block;
      min-width: 220px;
      width: auto;
      height: auto;
      background: var(--white);
      list-style: none;
      margin: 0;
      padding: 0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      z-index: 9999;
      opacity: 0;
      transform: translateY(-10px);
      transition:
        opacity 0.2s ease,
        transform 0.3s ease;
      pointer-events: none;
    }

    .nav-bar__dropdown:hover .nav-bar__dropdown-menu,
    .nav-bar__dropdown.open .nav-bar__dropdown-menu {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .nav-bar__dropdown-link {
      padding: 14px 16px;
      white-space: nowrap;
    }

    .nav-bar__dropdown-link:hover {
      background-color: var(--neutral-lighter);
    }
  }
</style>
