---
interface Link {
  href: string;
  label: string;
}

interface Props {
  triggerText: string;
  links: Link[];
  triggerHref?: string;
}

const { triggerText, links, triggerHref = "#" } = Astro.props;
---

<li class="nav-bar__dropdown">
  <a
    href={triggerHref}
    class="nav-bar__link nav-bar__dropdown-toggle"
    aria-haspopup="true"
    aria-expanded="false"
  >
    {triggerText}

    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="nav-bar__caret"
      width="24"
      height="24"
      fill="none"
      aria-hidden="true"
      viewBox="6.75 8.88 10.54 6.25"
      ><path
        d="M17.0002 9.17C16.8128 8.98375 16.5594 8.87921 16.2952 8.87921C16.031 8.87921 15.7776 8.98375 15.5902 9.17L12.0002 12.71L8.46019 9.17C8.27283 8.98375 8.01938 8.87921 7.75519 8.87921C7.49101 8.87921 7.23756 8.98375 7.05019 9.17C6.95646 9.26297 6.88207 9.37357 6.8313 9.49543C6.78053 9.61729 6.75439 9.74799 6.75439 9.88C6.75439 10.012 6.78053 10.1427 6.8313 10.2646C6.88207 10.3864 6.95646 10.497 7.05019 10.59L11.2902 14.83C11.3832 14.9237 11.4938 14.9981 11.6156 15.0489C11.7375 15.0997 11.8682 15.1258 12.0002 15.1258C12.1322 15.1258 12.2629 15.0997 12.3848 15.0489C12.5066 14.9981 12.6172 14.9237 12.7102 14.83L17.0002 10.59C17.0939 10.497 17.1683 10.3864 17.2191 10.2646C17.2699 10.1427 17.296 10.012 17.296 9.88C17.296 9.74799 17.2699 9.61729 17.2191 9.49543C17.1683 9.37357 17.0939 9.26297 17.0002 9.17Z"
        fill="currentColor"></path></svg
    >
  </a>

  <!-- Dropdown Menu -->
  <ul class="nav-bar__dropdown-menu" role="menu">
    {
      links.map((link) => (
        <li role="none">
          <a href={link.href} class="nav-bar__dropdown-link" role="menuitem">
            {link.label}
          </a>
        </li>
      ))
    }
  </ul>
</li>

<style>
  .nav-bar__dropdown > .nav-bar__dropdown-toggle {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    width: 100%;
  }
  .nav-bar__caret {
    width: 10.54px;
    height: 6.25px;
    transform: rotate(-90deg);
    transition: transform 0.2s ease;
    margin-left: auto;
    color: var(--text);
  }
  .nav-bar__dropdown.open .nav-bar__caret {
    transform: rotate(0deg);
  }

  .nav-bar__dropdown.open .nav-bar__dropdown-menu {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  .nav-bar__dropdown .nav-bar__dropdown-menu {
    display: none;
    margin-top: 10px;
    background-color: var(--neutral-lightest);
    width: 100%;
    border-radius: 3px;
  }

  .nav-bar__dropdown.open .nav-bar__dropdown-menu {
    display: block;
  }

  .nav-bar__dropdown.open .nav-bar__dropdown-toggle {
    color: var(--primary);
  }

  .nav-bar__dropdown-link {
    display: block;
    color: var(--text);
    font-size: var(--fs-body-r);
    padding: 14px 12px;
    width: 100%;
    border-bottom: 1px solid var(--grey-10);
  }
  .nav-bar__dropdown-menu li:last-child .nav-bar__dropdown-link {
    border-bottom: none;
  }

  @media (min-width: 992px) {
    .nav-bar__dropdown {
      position: relative;
    }
    .nav-bar__dropdown::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      height: 8px;
      background: transparent;
    }

    .nav-bar__dropdown .nav-bar__dropdown-menu {
      position: absolute;
      top: calc(100% + 8px);
      left: 7px;
      display: block;
      min-width: 220px;
      width: auto;
      height: auto;
      background: var(--white);
      list-style: none;
      margin: 0;
      padding: 0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      z-index: 9999;
      opacity: 0;
      transform: translateY(-10px);
      transition:
        opacity 0.2s ease,
        transform 0.3s ease;
      pointer-events: none;
    }

    .nav-bar__dropdown:hover .nav-bar__dropdown-menu,
    .nav-bar__dropdown.open .nav-bar__dropdown-menu {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .nav-bar__dropdown:hover .nav-bar__dropdown-toggle {
      transform: none;
      color: var(--neutral-lighter);
    }
    .nav-bar__dropdown.open .nav-bar__dropdown-toggle {
      color: var(--neutral-lighter) !important;
    }

    .nav-bar__dropdown-link {
      padding: 14px 16px;
      white-space: nowrap;
    }

    .nav-bar__dropdown-link:hover {
      background-color: var(--neutral-lighter);
    }

    .nav-bar__caret {
      width: 10.54px;
      height: 6.25px;
      transform: rotate(0deg);
      margin-left: 6px;
      color: var(--white);
    }

    .nav-bar__dropdown:hover .nav-bar__caret {
      transform: none;
      color: var(--neutral-lighter);
    }
    /* Also style the caret when open */
    .nav-bar__dropdown.open .nav-bar__caret {
      color: var(--neutral-lighter) !important;
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const dropdownToggle = document.querySelector(".nav-bar__dropdown-toggle");
    const dropdown = document.querySelector(".nav-bar__dropdown");

    if (!dropdownToggle || !dropdown) return;

    let clickCount = 0;
    let clickTimer: NodeJS.Timeout;
    let preventAutoClose = false;
    let listenersAttached = false;

    function toggleDropdown() {
      if (!dropdown || !dropdownToggle) return;

      const isOpen = dropdown.classList.contains("open");

      // Close all other dropdowns
      document.querySelectorAll(".nav-bar__dropdown.open").forEach((d) => {
        if (d !== dropdown) {
          d.classList.remove("open");
          const toggle = d.querySelector(".nav-bar__dropdown-toggle");
          if (toggle) toggle.setAttribute("aria-expanded", "false");
        }
      });

      if (!isOpen) {
        openDropdown();
      } else {
        closeDropdown();
      }
    }

    function handleDropdownClick(e: Event) {
      if (!dropdownToggle) return;
      e.preventDefault();

      clickCount++;

      if (clickCount === 1) {
        toggleDropdown();
        clickTimer = setTimeout(() => {
          clickCount = 0;
        }, 300);
      } else if (clickCount === 2) {
        clearTimeout(clickTimer);
        clickCount = 0;
        window.location.href = dropdownToggle.getAttribute("href") || "#";
      }
    }

    function openDropdown() {
      if (!dropdown || !dropdownToggle) return;
      dropdown.classList.add("open");
      dropdownToggle.setAttribute("aria-expanded", "true");
    }

    function closeDropdown() {
      if (!dropdown || !dropdownToggle) return;
      dropdown.classList.remove("open");
      dropdownToggle.setAttribute("aria-expanded", "false");
    }

    // Event handlers
    function handleDocumentClick(e: Event) {
      if (!e.target || !dropdown || !dropdown.contains(e.target as Node)) {
        closeDropdown();
        preventAutoClose = false;
        clickCount = 0;
      }
    }

    function handleDropdownLinkClick(e: Event) {
      if (!e.target) return;
      if ((e.target as Element).closest(".nav-bar__dropdown-link")) {
        closeDropdown();
      }
    }

    function removeAllListeners() {
      if (!dropdown || !dropdownToggle) return;
      dropdownToggle.removeEventListener("click", handleDropdownClick);
      document.removeEventListener("click", handleDocumentClick);
      dropdown.removeEventListener("click", handleDropdownLinkClick);
    }

    function setupEventListeners() {
      if (!dropdown || !dropdownToggle || listenersAttached) return;
      removeAllListeners();

      const isMobile = window.innerWidth < 992;

      if (isMobile) {
        // Mobile: Click to toggle, click outside to close
        dropdownToggle.addEventListener("click", handleDropdownClick);
        document.addEventListener("click", handleDocumentClick);
      } else {
        // Desktop: Hybrid hover + click behavior
        dropdownToggle.addEventListener("click", (e) => {
          e.preventDefault();
          preventAutoClose = true;
          handleDropdownClick(e);
        });

        document.addEventListener("click", handleDocumentClick);
        dropdown.addEventListener("click", handleDropdownLinkClick);
      }
      listenersAttached = true;
    }

    // Initial setup
    setupEventListeners();

    // Update on resize
    window.addEventListener("resize", () => {
      setTimeout(setupEventListeners, 10);
    });
  });
</script>
